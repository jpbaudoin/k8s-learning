apiVersion: skaffold/v2beta9
kind: Config
metadata:
  name: kubemq-test-drive

build:
  artifacts:
  - image: sender
    context: dev/sender
  - image: receiver
    context: dev/receiver
  - image: receiver2
    context: dev/receiver2

profiles:
  - name: dev
    activation:
      - command: dev
    build:
      artifacts:
      - image: sender
        context: dev/sender # Path to image folder
        docker:
          buildArgs:
            ENV: "DEV"      # This variable is used within the docker file to allow permission for skaffold to sync files
        sync:
          manual:
          - src: "*.py"
            dest: "/app/"
            #strip: "dev/sender"
      - image: receiver
        context: dev/receiver
        docker:
          buildArgs:
            F_OWNER: "1000"
        # Sync requires that the dest container has tar installed. With distroless images this may be an issue
        # For dev
        sync:
          infer: 
          - "**/*"
      - image: receiver2        # Go application, build is done within the docker file
        context: dev/receiver2
        docker:
          buildArgs:
            GO_IMAGE: "alpine:3"

deploy:
  helm:
    releases:
    - name: release1
      createNamespace: true
      artifactOverrides:
        senderImage: sender
        receiverImage: receiver
        receiver2Image: receiver2
      chartPath: ./charts/kubemq-test-drive
      namespace: test1
      valuesFiles:
      - ./charts/kubemq-test-drive/values.yaml

